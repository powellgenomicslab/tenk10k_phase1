#!/bin/bash
#$ -S /bin/bash
#$ -cwd
#$ -V
#$ -r yes
#$ -l mem_requested=100G
#$ -l tmp_requested=50G
#$ -l nvgpu=3
#$ -N cellbender_TenK10K_scRNA
#$ -e /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output/logs/cellbender_TenK10K_scRNA_S0036b.err
#$ -o /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output/logs/cellbender_TenK10K_scRNA_S0036b.log
#$ -t 1-1
#$ -m ae
#$ -M a.cuomo@garvan.org.au

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/share/ScratchGeneral/anncuo/jupyter/conda_notebooks/envs/cellbender/lib/

echo "----------------------------------------------------------------"
echo " Running CellBender on TenK10K_scRNA samples"
echo "----------------------------------------------------------------"

#i=${SGE_TASK_ID};
#SAMPLE=$(sed "${i}q;d" /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellranger_outs.txt)

SAMPLE=S0036b

echo "Performing ambient background removal on sample: $SAMPLE"

mkdir /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output_smaller_learning_rate/${SAMPLE}
cd /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output_smaller_learning_rate/${SAMPLE}

COUNTS="/directflow/SCCGGroupShare/projects/data/experimental_data/projects/TenK10K/GencodeV44/$SAMPLE/outs/raw_feature_bc_matrix.h5"
CELLBENDER_OUTDIR="/share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output_smaller_learning_rate/${SAMPLE}/"

conda run -n cellbender cellbender remove-background \
      --cuda \
      --input $COUNTS \
      --output ${CELLBENDER_OUTDIR}cellbender_output.h5 \
      --learning-rate 1e-6
