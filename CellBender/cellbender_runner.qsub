#!/bin/bash
#$ -S /bin/bash
#$ -cwd
#$ -V
#$ -r yes
#$ -l mem_requested=80G
#$ -l nvgpu=3
#$ -N cellbender_TenK10K_scRNA
#$ -e /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output/logs/cellbender_TenK10K_scRNA.err
#$ -o /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output/logs/cellbender_TenK10K_scRNA.log
#$ -t 1-64

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/share/ScratchGeneral/anncuo/jupyter/conda_notebooks/envs/cellbender/lib/

echo "----------------------------------------------------------------"
echo " Running CellBender on TenK10K_scRNA samples"
echo "----------------------------------------------------------------"

i=${SGE_TASK_ID};

SAMPLE=$(sed "${i}q;d" /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellranger_outs.txt)

echo "Performing ambient background removal on sample: $SAMPLE"

mkdir /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output/${SAMPLE}
cd /share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output/${SAMPLE}

COUNTS="/directflow/SCCGGroupShare/projects/data/experimental_data/projects/TenK10K/GencodeV44/$SAMPLE/outs/raw_feature_bc_matrix.h5"
CELLBENDER_OUTDIR="/share/ScratchGeneral/anncuo/tenk10k/data_processing/cellbender_output/${SAMPLE}/"

conda run -n cellbender cellbender remove-background \
      --cuda \
      --input $COUNTS \
      --output ${CELLBENDER_OUTDIR}cellbender_output.h5 \
      --learning-rate 1e-6
